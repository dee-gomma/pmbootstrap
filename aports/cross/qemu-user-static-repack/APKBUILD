pkgname=qemu-user-static-repack
pkgver=2.8
##############################################################################
# WARNING: original file is based on x86_64 architecture, here values have 
#          been overwritten for x86. Better solution: add suffix to package,
#          and keep both
##############################################################################
_debver=${pkgver}+dfsg-7_i386
pkgrel=8
pkgdesc="QEMU user mode emulation binaries (static version)"
arch=x86
url="https://wiki.debian.org/DebianKernel/ARMMP"
license="GPL2"
source="https://ftp.us.debian.org/debian/pool/main/q/qemu/qemu-user-static_${_debver}.deb"
makedepends="tar xz"
subpackages="$pkgname-doc $pkgname-binfmt:binfmt:noarch"
options="!check"

unpack() {
	cd "$srcdir"
	for i in $source; do
		case $i in
			*.deb) ar x ${i##*/} ;;
		esac
	done

	# postinst in this archive contains the binfmt information
	tar -xf "$srcdir/control.tar.gz"
}

package() {
	mkdir -p "$pkgdir"
	tar -xJf "$srcdir"/data.tar.xz -C $pkgdir
	return 0
}

_binfmtout="$srcdir/qemu-user-binfmt.txt"
build() {
	cd "$srcdir"
	for line in \
		"# Non-standard file format with grepped binfmt information" \
		"# from Debians postinst script. Used in pmbootstrap."
	do
		echo "$line" >> $_binfmtout
	done

	for suffix in mask magic; do
		grep "_${suffix}=" postinst >> $_binfmtout
	done
}

binfmt() {
	mkdir -p "$pkgdir-binfmt"
	install -Dm644 $_binfmtout \
		"$pkgdir-binfmt/usr/share/qemu-user-binfmt.txt"
}

sha512sums="7b9ead3e834c32dd249456a73153fa27ff1dc7cc5b281ddbcd62f943c3283512fcce91eefb0790d35957763b74d537b475fe49cccecb9d5e4216d98028c8adaf qemu-user-static_2.8+dfsg-7_i386.deb"
